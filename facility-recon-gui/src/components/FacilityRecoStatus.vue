<template>
  <v-container fluid>
    <v-dialog v-model="mappingStatusDialog" transition="scale-transition" hide-overlay persistent width="350">
      <v-card color="white" dark>
        <v-card-text>
          <center>
            <font style="color:blue">{{mappingStatusProgressTitle}}</font><br>
            <v-progress-circular :rotate="-90" :size="100" :width="15" :value="mappingStatusProgressPercent" color="primary" v-if="progressType == 'percent'">
              <v-avatar color="indigo" size="50px">
                <span class="white--text">
                  <b>{{ mappingStatusProgressPercent }}%</b>
                </span>
              </v-avatar>
            </v-progress-circular>
            <v-progress-linear indeterminate color="red" class="mb-0" v-if="progressType == 'indeterminate'"></v-progress-linear>
          </center>
        </v-card-text>
      </v-card>
    </v-dialog>
    <v-layout column>
      <v-flex xs1>
        <v-layout row wrap>
          <v-flex xs6>
            <b>All Levels</b>
          </v-flex>
          <v-spacer></v-spacer>
          <v-flex xs4>
            <b>Level {{recoLevel-1}} Only</b>
          </v-flex>
        </v-layout>
      </v-flex>
      <v-flex xs1>
        <v-layout row wrap>
          <v-flex xs1>
            <v-chip color="red" text-color='white' style='height:138px;width:137px'>
              <v-layout column>
                <v-flex xs1>
                  <v-icon light>thumb_up</v-icon>
                  <b>Source 1 Matched</b>
                </v-flex>
                <v-flex xs1 align-center>
                  <center>
                    <b>{{$store.state.totalAllMapped}}/{{$store.state.source1TotalAllRecords}}</b>
                  </center>
                </v-flex>
                <v-flex xs1>
                  <center>
                    <v-progress-circular :rotate="-90" :size="65" :width="8" :value="source1PercentMapped" color="yellow">
                      <font color="white">
                        <b>{{ source1PercentMapped }}%</b>
                      </font>
                    </v-progress-circular>
                  </center>
                </v-flex>
              </v-layout>
            </v-chip>
          </v-flex>
          <v-flex xs1>
            <v-chip color="red" text-color='white' style='height:138px;width:144px'>
              <v-layout column>
                <v-flex xs1>
                  <v-icon light>thumb_up</v-icon>
                  <b>Source 1 Not Mapped</b>
                </v-flex>
                <v-flex xs1 align-center>
                  <center>
                    <b>{{$store.state.source1TotalAllNotMapped}}/{{$store.state.source1TotalAllRecords}}</b>
                  </center>
                </v-flex>
                <v-flex xs1>
                  <center>
                    <v-progress-circular :rotate="-90" :size="65" :width="8" :value="source1PercentNotMapped" color="yellow">
                      <font color="white">
                        <b>{{ source1PercentNotMapped }}%</b>
                      </font>
                    </v-progress-circular>
                  </center>
                </v-flex>
              </v-layout>
            </v-chip>
          </v-flex>
          <v-flex xs1>
            <v-chip color="red" text-color='white' style='height:138px;width:137px'>
              <v-layout column>
                <v-flex xs1>
                  <v-icon light>thumb_down</v-icon>
                  <b>Source 1 No Match</b>
                </v-flex>
                <v-flex xs1 align-center>
                  <center>
                    <b>{{$store.state.totalAllNoMatch}}/{{$store.state.source1TotalAllRecords}}</b>
                  </center>
                </v-flex>
                <v-flex xs1>
                  <center>
                    <v-progress-circular :rotate="-90" :size="65" :width="8" :value="source1PercentNoMatch" color="yellow">
                      <font color="white">
                        <b>{{ source1PercentNoMatch }}%</b>
                      </font>
                    </v-progress-circular>
                  </center>
                </v-flex>
              </v-layout>
            </v-chip>
          </v-flex>
          <v-flex xs1>
            <v-chip color="red" text-color='white' style='height:138px;width:137px'>
              <v-layout column>
                <v-flex xs1>
                  <v-icon light>notification_important</v-icon>
                  <b>Source 1 Flagged</b>
                </v-flex>
                <v-flex xs1 align-center>
                  <center>
                    <b>{{$store.state.totalAllFlagged}}/{{$store.state.source1TotalAllRecords}}</b>
                  </center>
                </v-flex>
                <v-flex xs1>
                  <center>
                    <v-progress-circular :rotate="-90" :size="65" :width="8" :value="source1PercentFlagged" color="yellow">
                      <font color="white">
                        <b>{{ source1PercentFlagged }}%</b>
                      </font>
                    </v-progress-circular>
                  </center>
                </v-flex>
              </v-layout>
            </v-chip>
          </v-flex>
          <v-flex xs1>
            <v-chip color="red" text-color='white' style='height:138px;width:137px'>
              <v-layout column>
                <v-flex xs1>
                  <v-icon light>thumb_up</v-icon>
                  <b>Source 2 Matched</b>
                </v-flex>
                <v-flex xs1 align-center>
                  <center>
                    <b>{{$store.state.totalAllMapped}}/{{$store.state.source2TotalAllRecords}}</b>
                  </center>
                </v-flex>
                <v-flex xs1>
                  <center>
                    <v-progress-circular :rotate="-90" :size="65" :width="8" :value="source2PercentMapped" color="yellow">
                      <font color="white">
                        <b>{{ source2PercentMapped }}%</b>
                      </font>
                    </v-progress-circular>
                  </center>
                </v-flex>
              </v-layout>
            </v-chip>
          </v-flex>
          <v-flex xs1>
            <v-chip color="red" text-color='white' style='height:138px;width:137px'>
              <v-layout column>
                <v-flex xs1>
                  <v-icon light>notification_important</v-icon>
                  <b>Source 2 Flagged</b>
                </v-flex>
                <v-flex xs1 align-center>
                  <center>
                    <b>{{$store.state.totalAllFlagged}}/{{$store.state.source2TotalAllRecords}}</b>
                  </center>
                </v-flex>
                <v-flex xs1>
                  <center>
                    <v-progress-circular :rotate="-90" :size="65" :width="8" :value="source2PercentFlagged" color="yellow">
                      <font color="white">
                        <b>{{ source2PercentFlagged }}%</b>
                      </font>
                    </v-progress-circular>
                  </center>
                </v-flex>
              </v-layout>
            </v-chip>
          </v-flex>
          <v-spacer></v-spacer>
          <v-flex xs1>
            <v-chip color="green" text-color='white' style='height:138px;width:137px'>
              <v-layout column>
                <v-flex xs1>
                  <v-icon light>thumb_up</v-icon>
                  <b>Source 1 Matched</b>
                </v-flex>
                <v-flex xs1 align-center>
                  <center>
                    <b>{{totalMapped}}/{{totalRecords}}</b>
                  </center>
                </v-flex>
                <v-flex xs1>
                  <center>
                    <v-progress-circular :rotate="-90" :size="65" :width="8" :value="source1PercentMappedLevel" color="yellow">
                      <font color="white">
                        <b>{{ source1PercentMappedLevel }}%</b>
                      </font>
                    </v-progress-circular>
                  </center>
                </v-flex>
              </v-layout>
            </v-chip>
          </v-flex>
          <v-flex xs1>
            <v-chip color="green" text-color='white' style='height:138px;width:143px'>
              <v-layout column>
                <v-flex xs1>
                  <v-icon light>thumb_down</v-icon>
                  <b>Source 1 Not Mapped</b>
                </v-flex>
                <v-flex xs1 align-center>
                  <center>
                    <b>{{totalNotMapped}}/{{totalRecords}}</b>
                  </center>
                </v-flex>
                <v-flex xs1>
                  <center>
                    <v-progress-circular :rotate="-90" :size="65" :width="8" :value="source1PercentNotMappedLevel" color="yellow">
                      <font color="white">
                        <b>{{ source1PercentNotMappedLevel }}%</b>
                      </font>
                    </v-progress-circular>
                  </center>
                </v-flex>
              </v-layout>
            </v-chip>
          </v-flex>
          <v-flex xs1>
            <v-chip color="green" text-color='white' style='height:138px;width:137px'>
              <v-layout column>
                <v-flex xs1>
                  <v-icon light>thumb_down</v-icon>
                  <b>Source 1 No Match</b>
                </v-flex>
                <v-flex xs1 align-center>
                  <center>
                    <b>{{totalNoMatch}}/{{totalRecords}}</b>
                  </center>
                </v-flex>
                <v-flex xs1>
                  <center>
                    <v-progress-circular :rotate="-90" :size="65" :width="8" :value="source1PercentNoMatchLevel" color="yellow">
                      <font color="white">
                        <b>{{ source1PercentNoMatchLevel }}%</b>
                      </font>
                    </v-progress-circular>
                  </center>
                </v-flex>
              </v-layout>
            </v-chip>
          </v-flex>
          <v-flex xs1>
            <v-chip color="green" text-color='white' style='height:138px;width:137px'>
              <v-layout column>
                <v-flex xs1>
                  <v-icon light>notification_important</v-icon>
                  <b>Source 1 Flagged</b>
                </v-flex>
                <v-flex xs1 align-center>
                  <center>
                    <b>{{totalFlagged}}/{{totalRecords}}</b>
                  </center>
                </v-flex>
                <v-flex xs1>
                  <center>
                    <v-progress-circular :rotate="-90" :size="65" :width="8" :value="source1PercentFlagged" color="yellow">
                      <font color="white">
                        <b>{{ source1PercentFlagged }}%</b>
                      </font>
                    </v-progress-circular>
                  </center>
                </v-flex>
              </v-layout>
            </v-chip>
          </v-flex>
        </v-layout>
      </v-flex>
      <v-flex xs1>
        <v-layout row wrap>
          <v-flex xs1 sm2 md2 right>
            <v-select :items="locationLevels" v-model="recoLevel" :item-value='locationLevels.value' :item-name='locationLevels.text' label="Level" class="input-group--focused" height='1' full-width @change="levelChanged" single-line>
            </v-select>
          </v-flex>
          <v-spacer></v-spacer>
          <!--
          <v-flex xs2>
            <v-btn color="success" round @click='markRecoDone' v-if="$store.state.recoStatus.status !== 'done'"><v-icon>lock</v-icon>Mark Reconciliation Done</v-btn>
            <v-btn color="success" round @click='markRecoUnDone' v-else><v-icon>lock_open</v-icon>Mark Reconciliation UnDone</v-btn>
          </v-flex>
          <v-spacer></v-spacer>
          -->
          <v-flex xs3>
            <v-text-field v-model="searchMatched" append-icon="search" label="Search" single-line hide-details></v-text-field>
          </v-flex>
        </v-layout>
      </v-flex>
      <v-flex xs1>
        <v-tabs icons-and-text centered grow dark color="cyan">
          <v-tabs-slider color="red"></v-tabs-slider>
          <v-tab key="match">
            MATCHED ({{totalMapped}})
            <v-icon color="white" right>thumb_up</v-icon>
          </v-tab>
          <v-tab key="notMapped">
            Source 1 Not Mapped ({{totalNotMapped}})
            <v-icon color="white" right>thumb_down</v-icon>
          </v-tab>
          <v-tab key="nomatch">
            Source 1 NO MATCH ({{totalNoMatch}})
            <v-icon color="white" right>thumb_down</v-icon>
          </v-tab>
          <v-tab key="flagged">
            FLAGGED ({{totalFlagged}})
            <v-icon color="white" right>notification_important</v-icon>
          </v-tab>
          <v-tab-item key="match">
            <v-data-table :headers="matchedHeaders" :items="mappingData.mapped" :search="searchMatched" class="elevation-1">
              <template slot="items" slot-scope="props">
                <td>{{props.item.source1Name}}</td>
                <td>{{props.item.source1Id}}</td>
                <td>{{props.item.source2Name}}</td>
                <td>{{props.item.source2Id}}</td>
              </template>
            </v-data-table>
          </v-tab-item>
          <v-tab-item key="notMapped">
            <v-data-table :headers="notMappedHeaders" :items="mappingData.notMapped" :search="searchMatched" class="elevation-1">
              <template slot="items" slot-scope="props">
                <td>{{props.item.source1Name}}</td>
                <td>{{props.item.source1Id}}</td>
              </template>
            </v-data-table>
          </v-tab-item>
          <v-tab-item key="nomatch">
            <v-data-table :headers="noMatchHeaders" :items="mappingData.noMatch" :search="searchMatched" class="elevation-1">
              <template slot="items" slot-scope="props">
                <td>{{props.item.source1Name}}</td>
                <td>{{props.item.source1Id}}</td>
              </template>
            </v-data-table>
          </v-tab-item>
          <v-tab-item key="flagged">
            <v-data-table :headers="flaggedHeaders" :items="mappingData.flagged" :search="searchMatched" class="elevation-1">
              <template slot="items" slot-scope="props">
                <td>{{props.item.source1Name}}</td>
                <td>{{props.item.source1Id}}</td>
                <td>{{props.item.source2Name}}</td>
                <td>{{props.item.source2Id}}</td>
              </template>
            </v-data-table>
          </v-tab-item>
        </v-tabs>
      </v-flex>
      </v-flex>
    </v-layout>
  </v-container>
</template>

<script>
import { scoresMixin } from '../mixins/scoresMixin'
import axios from 'axios'
const config = require('../../config')
const isProduction = process.env.NODE_ENV === 'production'
const backendServer = (isProduction ? config.build.backend : config.dev.backend)
export default {
  mixins: [scoresMixin],
  data () {
    return {
      matchedHeaders: [
        { text: 'Source 1 Location', value: 'source1Name' },
        { text: 'Source 1 ID', value: 'source1Id' },
        { text: 'Source 2 Location', value: 'source2Name' },
        { text: 'Source 2 ID', value: 'source2Id' }
      ],
      noMatchHeaders: [
        { text: 'Source 1 Location', value: 'source1Name' },
        { text: 'Source 1 ID', value: 'source1Id' }
      ],
      notMappedHeaders: [
        { text: 'Source 1 Location', value: 'source1Name' },
        { text: 'Source 1 ID', value: 'source1Id' }
      ],
      flaggedHeaders: [
        { text: 'Source 1 Location', value: 'source1Name' },
        { text: 'Source 1 ID', value: 'source1Id' },
        { text: 'Source 2 Location', value: 'source2Name' },
        { text: 'Source 2 ID', value: 'source2Id' }
      ],
      searchMatched: '',
      mappingData: {},
      recoLevel: 2,
      mappingStatusDialog: false,
      mappingStatusProgressTitle: 'Waiting for progress status',
      mappingStatusProgressPercent: 0,
      locationLevels: []
    }
  },
  methods: {
    checkMappingStatusProgress () {
      const clientId = this.$store.state.clientId
      axios.get(backendServer + '/mappingStatusProgress/' + clientId).then((mappingStatusProgress) => {
        if (mappingStatusProgress.data === null || mappingStatusProgress.data === undefined || mappingStatusProgress.data === false) {
          clearInterval(this.mappingStatusProgressTimer)
          return
        }
        this.mappingStatusProgressTitle = mappingStatusProgress.data.status
        if (mappingStatusProgress.data.percent) {
          if (this.progressType !== 'percent') {
            this.progressType = 'percent'
          }
          this.mappingStatusProgressPercent = mappingStatusProgress.data.percent
        }
        if (mappingStatusProgress.data.status === 'Done') {
          clearInterval(this.mappingStatusProgressTimer)
          this.mappingStatusDialog = false
          this.mappingStatusProgressTitle = 'Waiting for progress status'
        }
      }).catch((err) => {
        console.log(err)
      })
    },
    mappingStatus () {
      if (!this.source1 || !this.source2) {
        return
      }
      this.mappingData = {}
      const clientId = this.$store.state.clientId
      let totalSource2Levels = this.$store.state.totalSource2Levels
      let totalSource1Levels = this.$store.state.totalSource1Levels
      this.mappingStatusDialog = true
      this.progressType = 'indeterminate'
      axios.get(backendServer + '/mappingStatus/' + this.source1 + '/' + this.source2 + '/' + this.recoLevel + '/' + totalSource2Levels + '/' + totalSource1Levels + '/' + clientId).then((mappingStatus) => {
        this.mappingData = mappingStatus.data
      })
      this.mappingStatusProgressTimer = setInterval(this.checkMappingStatusProgress, 500)
    },
    levelChanged (level) {
      this.recoLevel = level
      this.mappingStatus()
    },
    markRecoDone () {
      axios.get(backendServer + '/markRecoDone/' + this.source1 + '/' + this.source2).then((status) => {
        if (status.data.status) {
          this.$store.state.recoStatus.status = status.data.status
        }
      }).catch((err) => {
        console.log(err.response.data.error)
      })
    },
    markRecoUnDone () {
      axios.get(backendServer + '/markRecoUnDone/' + this.source1 + '/' + this.source2).then((status) => {
        if (status.data.status) {
          this.$store.state.recoStatus.status = status.data.status
        }
      }).catch((err) => {
        console.log(err.response.data.error)
      })
    }
  },
  computed: {
    source1 () {
      let source = this.$store.state.dataSourcePair.source1.name
      if (source) {
        source = this.toTitleCase(source)
      }
      return source
    },
    source2 () {
      let source = this.$store.state.dataSourcePair.source2.name
      if (source) {
        source = this.toTitleCase(source)
      }
      return source
    },
    source1PercentMapped () {
      if (this.$store.state.source1TotalAllRecords === 0) {
        return 0
      } else {
        return parseFloat((this.$store.state.totalAllMapped * 100 / this.$store.state.source1TotalAllRecords).toFixed(2))
      }
    },
    source1PercentMappedLevel () {
      if (this.totalRecords === 0) {
        return 0
      } else {
        return parseFloat((this.totalMapped * 100 / this.totalRecords).toFixed(2))
      }
    },
    source1PercentNoMatch () {
      if (this.$store.state.source1TotalAllRecords === 0) {
        return 0
      } else {
        return parseFloat((this.$store.state.totalAllNoMatch * 100 / this.$store.state.source1TotalAllRecords).toFixed(2))
      }
    },
    source1PercentNoMatchLevel () {
      if (this.totalRecords === 0) {
        return 0
      } else {
        return parseFloat((this.totalNoMatch * 100 / this.totalRecords).toFixed(2))
      }
    },
    source1PercentFlagged () {
      if (this.$store.state.source1TotalAllRecords === 0) {
        return 0
      } else {
        return parseFloat((this.$store.state.totalAllFlagged * 100 / this.$store.state.source1TotalAllRecords).toFixed(2))
      }
    },
    source1PercentFlaggedLevel () {
      if (this.totalRecords === 0) {
        return 0
      } else {
        return parseFloat((this.totalFlagged * 100 / this.totalRecords).toFixed(2))
      }
    },
    source1PercentNotMapped () {
      if (this.$store.state.source1TotalAllRecords === 0) {
        return 0
      } else {
        return parseFloat((this.$store.state.source1TotalAllNotMapped * 100 / this.$store.state.source1TotalAllRecords).toFixed(2))
      }
    },
    source1PercentNotMappedLevel () {
      if (this.totalRecords === 0) {
        return 0
      } else {
        return parseFloat((this.totalNotMapped * 100 / this.totalRecords).toFixed(2))
      }
    },
    source2PercentFlagged () {
      if (this.$store.state.source2TotalAllRecords === 0) {
        return 0
      } else {
        return parseFloat((this.$store.state.totalAllFlagged * 100 / this.$store.state.source2TotalAllRecords).toFixed(2))
      }
    },
    source2PercentMapped () {
      if (this.$store.state.source2TotalAllRecords === 0) {
        return 0
      } else {
        return parseFloat((this.$store.state.totalAllMapped * 100 / this.$store.state.source2TotalAllRecords).toFixed(2))
      }
    },
    totalMapped () {
      if (this.mappingData && this.mappingData.hasOwnProperty('mapped')) {
        return this.mappingData.mapped.length
      } else {
        return 0
      }
    },
    totalNotMapped () {
      if (this.mappingData && this.mappingData.hasOwnProperty('notMapped')) {
        return this.mappingData.notMapped.length
      } else {
        return 0
      }
    },
    totalNoMatch () {
      if (this.mappingData && this.mappingData.hasOwnProperty('noMatch')) {
        return this.mappingData.noMatch.length
      } else {
        return 0
      }
    },
    totalFlagged () {
      if (this.mappingData && this.mappingData.hasOwnProperty('flagged')) {
        return this.mappingData.flagged.length
      } else {
        return 0
      }
    },
    totalRecords () {
      return this.totalMapped + this.totalNotMapped + this.totalNoMatch + this.totalFlagged
    }
  },
  created () {
    this.mappingStatus()
    for (var k = 1; k < this.$store.state.totalSource1Levels; k++) {
      this.locationLevels.push({
        text: 'Level ' + k,
        value: k + 1
      })
    }
  }
}
</script>
